---
title: 分布式事务基本概念
date: 2018-01-03 23:11:29
update: 2018-01-03 23:11:29
categories: 互联网技术
tags: [互联网技术]
---
给朋友们普及一下分布式事务的知识。  

在互联网行业，分布式应用的越来越广泛。  
在单机环境很容易实现数据库的ACID特性。但在分布式系统中，数据库和代码分散到不同的机器上，如何保证事务是非常大的挑战。  
# 一、基本理论
首先看几个基本概念：
## 1，ACID
ACID是数据库事务的四个特性：原子性A、一致性C、隔离性I、持久性D。  

### 原子性A
事务必须是一个原子的操作单元，操作要某全部成功，要某全部失败。  

### 一致性
一个事务在执行前后，数据库必须处于一致性状态。事务的结果必须是使数据库从一个状态转变到另一个状态。  
当数据库事务成功提交时，能说数据库处于一致性状态。  
如果数据库在运行过程中发生故障，事务尚未完成中断，这些事务对数据的修改一部分已写入库，这时数据库就处于不一致的状态。  
### 隔离性
并发环境中，事务是相互隔离的，一个事务的执行不能被其它的事务干扰。  
不同的事务并发操作时，每个事务都有各自完整的数据空间。  

### 持久性
持久性是事务一旦提交，它对数据库的改变应该是永久的。 数据更新必须永久的保存下来。  

## 2，CAP理论
上面说的ACID是针对本地事务的。本地事务可以用很成熟的ACID模型来保证数据的严格的一致性。  
CAP是说，一个分布式系统不可能同时满足： 一致性C、可用性A、分区容错性P。  
### 一致性
分布式环境中，一致性指数据在多个副本之间能否保持一致性。  
数据分布在不同的分布式结点，如果一个节点对数据进行了更新，却没有使第二个结果的数据更新。于是对第二个结点数据读取时，得到的是老数据(脏读)，这就是分布式数据不一致。  
如果对一个数据的更新，所有其它节点的用户都能读取到最新值，这就是**强一致性**。  

### 可用性
系统提供的服务一直处于可用的状态，对于用户的操作请求总是能够在有限的时间内返回结果。  

### 分区容错性
分布式系统在遇到任何网络分区故障时，仍然需要能够对外提供一致性和可用性的服务，除非是整个网络都发生了故障。  

上面说到CAP是指一个分布式系统无法同时满足三个要求。因此我们需要抛弃其中的一项。  
由于分区容错性是最基本的要求，不可能被舍掉，所以我们只能在一致性和可用性之前取舍。  

## 3、BASE理论
BASE是指基本可用(Basically Available)、软状态(Soft state)、最终一致性(Eventually consistent)。  
### 基本可用
分布式系统在出现不可预知故障时，允许损失部分可用性：  
响应时间变慢，或者非核心功能不可用

### 弱状态
允许数据库存在中间状态，并认为该中间状态并不会影响系统的整体可用性，即允许系统在不同的节点数据同步存在延时。

### 最终一致性
分布式系统所有的节点的数据，在经过一定时间后，最终能达到一个一致的状态。  
最终一致性的本质是需要系统最终保证数据能达到一致，而不需要保证系统的数据的强一致性。  

# 二、分布式算法
为了解决分布式事务问题，大师们实现了很多有用的算法，最有名的是：  
二阶段提交协议、三阶段提交协议、Paxos算法。

## 1、2PC
引入协调者来统一调度所有分布式节点的执行逻辑。  
二阶段提交协议。  
阶段一，提交事务请求  
(1)事务询问  
协调者向所有参与者发送事务内容，询问是否可以执行事务操作。  
(2)执行事务  
各参与者执行事务操作。  
(3)各参与者向协调者反馈事务询问的响应  
如果参与者成功执行了事务，反馈给协调者yes， 如果没有成功，则反馈no, 表示事务不可以执行。 

阶段二，执行事务提交  
(1)发送提交请求  
协调者向所有参与者发出事务提交请求。  
(2)事务提交
参与者正式提交事务。  
(3)反馈事务提交结果  
 完成事务后，向协调者发消息。  
(4)完成事务  
协调者收到所有参与者的消息，完成事务。  
  

假如任何一个参与者反馈了no给协调者，或者等待超时后，协调者还没有收到反馈，那么会中断事务。  
(1)发送回滚请求  
(2)事务回滚  
(3)反馈回滚结果  
(4)中断事务  

二阶段提交协议最主要问题：  
(1)同步阻塞的，会有很严重的性能问题。  
(2)在提交阶段，如果因为网络原因，可能会导致部分节点提交事务，部分节点回滚事务，导致数据不一致。  

## 2、3PC
三阶段提交协议是在二阶段基础上进行的改进。  
阶段一，CanCommit  
协调者询问是否可以提交事务；  
参与者反馈。  

阶段二，PreCommit  
如果协调者从所有反馈者获得的都是Yes, 那么向所有参与者发preCommit请求；  
参与者收到preCommit请求后，执行事务；  
参与者将事务执行的结果反馈给协调者。  
  
如果任何一个参与者反馈执行结果为no, 或者等待超时，协调者会中断事务：  
发所有参与者发中断请求；  
中断事务；  

阶段三，DoCommit  
真正的提交事务。  
协调者发提交请求；  
参与者收到请求后，正式提交事务；  
参与者把事务提交结果发送给协调者；  
协调者收到所有反馈后，完成事务。  
  
如果上面的操作，任意参与者反馈no, 或者协调者等待超时时间，那么协调者会中断事务：  
发送中断请求给所以参与者；  
所有参与者回滚事务；  
参与者反馈回滚结果给协调者；  
协调者收到所有反馈后，中断事务。  

一旦进入阶段三doCommit，如果协调者出现总是，参与者无法收到doCommit的消息，则参与者在等待超时后，继续事务提交。  
  
三阶段协议的主要缺点：  
在doCommit阶段，如果协调者或者网络出现问题，部分参与者收到回滚消息，部分参与者没有收到，会导致没有收到消息的参与者提交事务，导致数据不一致。  

## 3、Paxos
Paxos是解决分布式一致性最有效的算法之一。  
内容有点多，后面慢慢讲这个内容。  
计划至少还需要两章： Paxos详细介绍；分布式事务的具体解决方案。  
