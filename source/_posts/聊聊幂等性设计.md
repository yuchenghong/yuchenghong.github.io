---
title: 聊聊幂等性设计
date: 2018-01-01 18:54:44
update: 2018-01-01 18:54:44
categories: 互联网技术
tags: [互联网技术]
---
前一阵时间，碰到了幂等性的问题，这里作一下总结。  
所谓幂等性就是对于一个接口，如果参数一样，则不管调用多少次，对系统内部产生的影响是一致的。  
最常见的就是在支付扣款时，不管是调用分布式服务还是第三方接口，由于网络的不稳定和不确定性，扣款消息可能会调用到多次，这多次消息只能生效一次，否则会产生很严重的后果。  

我们碰到的业务场景：  
公司新接银行存管，调用银行存管接口的逻辑如下：  
1，用户发起操作；  
2，服务器验证后，调用银行存管接口进行交易；  
3，不管交易成功还是失败，银行存管接口会实时返回消息； 
4，服务器根据银行存管实时返回的消息，处理用户的订单。  

如果没有其它因素，上面的流程很完美，用户的交易或者成功或者失败。  
但是，由于网络本身就是不可靠的，极有可能会丢失消息。  

上面的交易流程，有可能产生问题的地方：  
一个是我们的消息，存管接口没有收到；  
二是存管接口收到了我们的消息，但返回给我们的消息，我们没有收到。   

对于第一个问题，存管没有收到消息，也就不会返回消息给我们，这种情况倒也不会产生数据的问题，用超时的机制就可以解决了。   
对于第二个问题，银行存管那边的方案是这样的：在同步返回交易结果的同时，也通过异步调用的方式消息返回给我们交易结果。异步返回时，需要我们回复"SUCESSFULL"信息，这样存管那边确认我们已经收到消息并已正确处理，否则存管会最多三次尝试异步回调。  
所以，可能网络原因，最差的情况，我们会收到1次同步消息，和3次异步消息。  
如果我们对这个消息没有做幂等处理的话，这个交易将会被处理4次，产生严重的数据问题。  
这里，最简单的处理办法就是处理消息时，把交易的ID做为主键存到数据库，多次存储数据库会直接报错。  

类似的场景很多，凡是有网络重发的地方，都需要考虑幂等性。  

可以从几个方面来看：  
1，对于只读的操作，一定是幂等的；  
2，更新数据操作：  
(1) 如果是类似更新状态这种操作，不管操作多少次，其结果是一样的，幂等；  
(2) 如果是更新类似金额这种，比如+100元，不幂等，多次操作会导致数据问题。  
(3) 插入数据库，不幂等；  
(4) 调用外部的接口，类似支付接口，不幂等。  

可以从几点来解决：  
1，所有的操作和交易，都必须有订单号，同一笔操作，必须保证其订单ID唯一；  
2，插入数据库时，订单ID做唯一性约束；有人说我的数据库分库分表了，唯一性约束不能保证啊。这就和你分库分表的规则有关了，即使分库分表，同样的操作也应该是写进同一表才对啊，否则分库分表的规则会很混乱。   
3，如果交易是需要调第三方接口的，一般第三方接口都会有唯一交易的ID，对应上我们的交易ID就可以；  
4，失败重试机制，必须保证同一个操作，其订单号相同。  

有资料说分布式锁，锁不一定能保证幂等性，这个坑是曾经有人跳过的。  

