---
title: 负载均衡和反向代理
date: 2018-01-03 21:38:43
update: 2018-01-03 21:38:43
categories: 互联网技术
tags: [互联网技术]
---
现在互联网应用，单台服务器处理的请求是有限的，为了满足业务增长和大量的用户量的增长。需要引用多台服务器。  
然后通过负载均衡机制将用户的请求分发到应用上的任意一台服务器。  

现在用的比较多的反向代理和负载均衡软件就是nginx,本文就是介绍nginx的反向代理和负载均衡基本用法。  
# 一、反向代理
nginx一个重要的功能就是反向代理，下面的负载均衡都是基于反向代理。  
客户端请求nginx，nginx请求应用服务器，然后将结果返回给客户端，此时Nginx就是反向代理服务器。  
nginx反向代理的指令不需要新增额外的模块，默认自带proxy_pass指令，只需要修改配置文件就可以实现反向代理。  
修改安装目录下conf子目录的nginx.conf文件：

```
server {
	listen 80;
	location / {
		proxy_pass http://192.168.1.5:8080; #应用服务器HTTP地址
	}
}
```
# 二、负载均衡
常见的负载均衡方案：  
1，首先在DNS，通过“DNS轮询”：对于一个域名配置了多个解析ip，每次DNS解析请求来访问DNS Server，会轮询返回这些ip，保证每个ip的解析概率是相同的。  
2，DNS解析的每个IP都对应到Nginx的外网IP，DNS解析后，请求就到了nginx。对于开发人员来说，可以只关心nginx就可以了。  

首先看看常见的负载均衡算法：  
1，轮询：  
将请求按顺序轮流地分配到后端服务器，在Nginx可以用weight参数来实现基于权重的轮询；  

2，随机：  
根据后端服务器列表随机选取其中的一台进行访问。  

3，Hash算法：  
根据用户访问的URL，通过Hash函数计算得到一个数值，该数值对服务器列表的大小取模运算，得到的结果就是要访问的服务器。  

4，一致性Hash:  
Hash算法最大的问题是当增加或者减少服务器时，会导致很多URL被重新均衡到不同的服务器。  
可以用一致性Hash算法解决这个问题，有关一致性hash算法，这里不详细讲了，可以百度找一下。  

下面看下在nginx如何配置负载均衡：  
负载均衡要用到nginx HTTP Upstream模块，默认安装就会带上这个模块。  
修改安装目录下conf子目录的nginx.conf文件：  

```
upstream webtest{  #集群的名字
    #ip_hash;  #负载均衡算法，默认是轮询
    server 127.0.0.1:8080 weight=1;
    server 127.0.0.1:8081 weight=1;
}

server {
    listen       80;  #监听80端口
    server_name  localhost;  #服务器域名

    location / {
        proxy_pass http://webtest;   #要与上面集群的名字一样
        proxy_redirect default;
    } 
}
```
负载算法：  
1，round-robin, 轮询,默认的算法；  
2，ip_hash,  相同的IP到同一台服务器；  
3，url_hash, 按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器;  
4，fair, 可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx本身是不支持fair的，如果需要使用这种调度算法，必须下载Nginx的upstream_fair模块。  

weight参数：  
权重，默认是1，权重越高，表示分配到该服务器请求就越多；  

upstream 支持的状态参数：  
在HTTP Upstream模块中，可以通过server指令指定后端服务器的IP地址和端口，同时还可以设定每个后端服务器在负载均衡调度中的状态。常用的状态有：  
1，down，表示当前的server暂时不参与负载均衡。  
2，backup，预留的备份机器。当其他所有的非backup机器出现故障或者忙的时候，才会请求backup机器，因此这台机器的压力最轻。  
3，max_fails，允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。  
4，fail_timeout，在经历了max_fails次失败后，暂停服务的时间。max_fails可以和fail_timeout一起使用。  
当负载调度算法为ip_hash时，后端服务器在负载均衡调度中的状态不能是weight和backup。  



